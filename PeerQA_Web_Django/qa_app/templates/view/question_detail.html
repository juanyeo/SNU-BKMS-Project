{% extends "view/base.html" %}
{% load static %}

{% block content %}

<div id="detail_header" style="margin-top: 10px; margin-left: 10px;">
    <p style = "font-size: 27px; font-weight: 500; margin-bottom: 6px">{{question.title}}</p> <!--원래 h2 -> p로해서 사이즈 customizing-->
    <span style = "font-size: 13px"><i class="fas fa-feather-alt" style="margin-right: 5px;"></i>작성자: {{question.user.first_name}}</span>
    <span style= "margin-left: 20px; font-size: 13px"><i class="far fa-clock" style="margin-right: 5pt;"></i>등록일시: {{question.postDate|date:"Y/m/d H:i"}}</span>
    <span style= "margin-left: 20px; font-size: 13px"><i class="fab fa-stack-overflow" style="margin-right: 5px;"></i>상태: {{question.status}}</span>
</div>
<hr class="h-color mx-2" style="margin-top: 8px; margin-bottom: 15px;">
<p style="font-size: 15px; margin-left: 10px; margin-bottom: 40px;">{{question.content | linebreaks}}</p>
{% if question.lecture_name != "" %}
<div class="card m-3 parent-card" style=" background-color: lightblue;">
    <div class="row no-gutters" >
        <div class= "col-12 col-md-6" >
            <div >
                <img style="min-height: 100%; padding: 5px" src="{{src_text}}" class="card-img-top" alt="...">
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card-body" style = "margin: 5px; text-align: right; max-width: 100%">
                <h3 class="card-title" style="color:navy; font-size: 20px; margin-bottom: 5px">연관 강의자료</h3>
                <hr style = "margin-top: 10px; margin-bottom: 10px;">
                <h4 style="margin-top: 5px; margin-bottom: 5px; font-size: 14px">{{question.lecture_name}}</h4>
                <p class="card-text" style = "font-size: 10px; margin-top: 5px ">페이지 : {{question.lecture_slide}} Page</p>
            </div>
        </div>
    </div>
</div>
{% endif %}
<div style = "display: flex; justify-content: right; margin-top: 30px">
    <form action="{% url 'scrap' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-dark" style="margin-right: 20px;
        background: #5E81F4; border: #5E81F4; padding: 3px 8px; font-size: 10px; margin-bottom: -25px">스크랩</button>
    </form>
</div>

<hr class="h-color mx-2"  style="margin-bottom: 6px;">
<div style="margin-left: 10px;">
    <span><i class="fas fa-lightbulb-on" style="color:tan; font-size: 12px"></i><span class="px-2" style = "font-size: 12px">진행 중인 토의</span></span>
    <span class="bg-warning rounded-pill text-white py-0 px-2" style = "font-size: 12px">{{count}}</span>
</div>


<!--<hr class="h-color mx-1" style = "margin-top: 6px">-->


<div class="container mb-4 py-3 text-dark">
    {% for comment in comment_list %}
    <div class="d-flex flex-start mt-4">
        <div style="display: flex; flex-direction: column; align-items: center;"> <!-- flex-start; margin-right: 10px;">-->
            <img class="rounded-circle shadow-1-strong me-3"
                 src="/static/image/question.jpeg" alt="avatar" width="50"
                 height="50" />

            {% if comment.owner_accepted == 1 %}
            <div style="padding-top: 20px;">
                <a href="#!" class="link-muted me-2" style='font-size:14px; color: dodgerblue'>
                    <i class="fas fa-check me-1" style='font-size:24px; color: dodgerblue'></i>
                </a>
            </div>
            {% endif %}

            {% if comment.admin_accepted == 1 %}
            <div style = "padding-top:20px;">
                <a class="link-muted" style='font-size:14px; color: darkblue'>
                    <i class="fas fa-check me-1" style='font-size:24px; color:darkblue'></i>
                </a>
            </div>
            {% endif %}

        </div>
        <div class="card w-100" style = "border-radius: 25px">
            <div class="card-body p-4">
                <div class="comment" style="word-wrap: break-word;">
                    <div style = "display: flex; align-items: center; padding-bottom: 0px;">
                        <p style = "flex: 1; font-weight: 600; margin-right: 12px; font-size: 14px;">{{comment.user.first_name}}</p>
                        <p class="small" style = "font-size: 11px; margin-left:10px">{{comment.postDate|date:"Y/m/d H:i"}}</p>
    <!--                    {{question.postDate|date:"Y/m/d H:i"}}-->
                    </div>
                        <p style = "font-size: 14px; padding-top: 0px;">
                            {{comment.content | linebreaks}}
                        </p>

                    <div class="d-flex justify-content-between align-items-center">
<!--                        <div class="d-flex align-items-center">-->
<!--                            {% if comment.owner_accepted == 1 %}-->
<!--                            <a href="#!" class="link-muted me-2" style='font-size:14px; color: dodgerblue'>-->
<!--                                <i class="fas fa-check me-1" style='font-size:24px; color: dodgerblue'></i>-->
<!--                                질문자 채택</a>-->
<!--                            {% endif %}-->
<!--                            {% if comment.admin_accepted == 1 %}-->
<!--                            <a class="link-muted" style='font-size:14px; color: darkblue'>-->
<!--                                <i class="fas fa-check me-1" style='font-size:24px; color:darkblue'></i>교수자 채택</a>-->
<!--                            {% endif %}-->
<!--                        </div>-->
<!--                        {% if user.id == question.user.id and comment.owner_accepted == 0 %}-->
<!--                        <form action="{% url 'comment_owner_like' comment.id %}" method="post">-->
<!--                            {% csrf_token %}-->
<!--&lt;!&ndash;                            <button type="submit" class="btn btn-dark btn-sm" style="margin-right: 20px; background: #5E81F4; border: #5E81F4;">질문 채택</button>&ndash;&gt;-->
<!--                            <button type="submit" class="btn btn-dark" style="margin-right: 20px; background-color: #5E81F4; border-color: #5E81F4; color: #fff; padding: 3px 8px; font-size: 10px;">질문 채택</button>-->
<!--                        </form>-->

<!--                        {% elif user.is_staff and comment.admin_accepted == 0 %}-->
<!--                        <form action="{% url 'comment_admin_like' comment.id %}" method="post">-->
<!--                            {% csrf_token %}-->
<!--&lt;!&ndash;                            <button type="submit" class="btn btn-dark btn-sm" style="margin-right: 20px; background: #5E81F4; border: #5E81F4;">질문 채택</button>&ndash;&gt;-->
<!--                            <button type="submit" class="btn btn-dark" style="margin-right: 20px; background-color: #21C197; border-color: #21C197; color: #fff; padding: 3px 8px; font-size: 10px;">질문 채택</button>-->
<!--                        </form>-->
<!--                        {% endif %}-->
                    </div>
                </div>
            </div>
        </div>
    </div><div class = "text-right" style = "margin-top: 7px;">{% if user.id == question.user.id and comment.owner_accepted == 0 %}
    <form action="{% url 'comment_owner_like' comment.id %}" method="post">
        {% csrf_token %}
        <!--                            <button type="submit" class="btn btn-dark btn-sm" style="margin-right: 20px; background: #5E81F4; border: #5E81F4;">질문 채택</button>-->
        <button type="submit" class="btn btn-dark" style="margin-right: 20px; background-color: #5E81F4; border-color: #5E81F4; color: #fff; padding: 3px 8px; font-size: 10px;">질문 채택</button>
    </form>

    {% elif user.is_staff and comment.admin_accepted == 0 %}
    <form action="{% url 'comment_admin_like' comment.id %}" method="post">
        {% csrf_token %}
        <!--                            <button type="submit" class="btn btn-dark btn-sm" style="margin-right: 20px; background: #5E81F4; border: #5E81F4;">질문 채택</button>-->
        <button type="submit" class="btn btn-dark" style="margin-right: 20px; background-color: #21C197; border-color: #21C197; color: #fff; padding: 3px 8px; font-size: 10px;">질문 채택</button>
    </form>
    {% endif %}</div>
    {% endfor %}
</div>

<form action="" method="post" id="commentForm" autocomplete="off">
    {% csrf_token %}
    <input type="hidden" id="question" name="question" value={{question.id}}>
    <input type="hidden" id="user" name="user" value="{{user.id}}">
    <div style= "margin-left: 10px;">
        <textarea type="content" name="content" value="{{content}}" class="form-control" rows="4" maxlength="300" placeholder="답글을 입력하세요" style = "font-size: 14px;"></textarea>
        <div class="row mt-2">
            <div class="col-12">
                <div class = "text-center">
                    <button type="submit" class="btn btn-dark btn-sm" style="margin-right: 20px; background: #5E81F4; border: #5E81F4;">답글 등록</button>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock content %}

{% block right %}
<div id="recom" question_data="{{question.title}}"></div>
<span id="jsoncontent"></span>
<script src="{% static 'js/jquery.js' %}"></script>
<script>
  $(document).ready(function() {
    var url = "http://127.0.0.1:5000/mixed";
    var questionTitle = $("#recom").attr("question_data");

    $.ajax({
      type: "GET",
      url: url,
      data: {'question_title': questionTitle},
      dataType: "json",
      success: function (data) {
        var response = JSON.stringify(data);
        response = response.replace(/"/gi, "");
        response = response.substring(1, response.length-1);

        var splitted_list = response.split(",");
        splitted_list.sort(() => Math.random() - 0.5);

        let stack_tag_start = `style="width: 100%; background-color: white; border-top-left-radius: 16px; border-bottom-left-radius: 16px; padding: 12px; margin-bottom: 20px;">
            <span style="color: orange; font-size: small;"><i class="fab fa-stack-overflow" style="color:chocolate"></i>  Stackoverflow 추천</span>
            <p style="font-weight: 600; margin-top: 8px; margin-bottom: 8px;">`;
        let stack_tag_middle = `</p><span style="color: blue; font-size: small;">`;
        let stack_tag_end = `</span></div>`;
        let board_tag_start = `style="width: 100%; background-color: white; border-top-left-radius: 16px; border-bottom-left-radius: 16px; padding: 12px; margin-bottom: 20px;">
            <span style="color: green; font-size: small;"><i class="fas fa-university" style="color:forestgreen"></i>  QA 게시글 추천</span>
            <p style="font-weight: 600; margin-top: 8px; margin-bottom: 8px;">`;
        let board_tag_middle = `</p><span style="color: blue; font-size: small;">`;
        let board_tag_end = `</span></div>`;

        var html_result = "";
        for(let i = 0; i < splitted_list.length; i++) {
            let tuple = splitted_list[i].split(":");
            if (tuple[0][0] == "w") {
                // Stackoverflow
                html_result += "<div onclick=\"location.href='https://"+tuple[0]+"'\" " + stack_tag_start + tuple[1] + stack_tag_middle + tuple[0] + stack_tag_end;
            } else {
                // 게시글 추천
                html_result += "<div onclick=\"location.href='"+tuple[0]+"'\" " + board_tag_start + tuple[1] + board_tag_middle + "눌러서 이동 ->" + board_tag_end;
            }
        }

        $("#jsoncontent").html(html_result);
      },
      error: function (req, status, error) {
        alert("code: "+req.status+"\nmessage: "+req.responseText+"\nerror: "+error);
      }
    });
  });
</script>
{% endblock right %}
